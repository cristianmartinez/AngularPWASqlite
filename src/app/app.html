<div class="app-container">
  <header>
    <h1>Angular PWA + SQLite</h1>
    <div class="status-bar">
      <span class="badge" [class.active]="dbReady()">
        DB: {{ dbReady() ? 'v' + dbVersion() : 'Loading...' }}
      </span>
      <select
        class="backend-select"
        [ngModel]="preferredBackend()"
        (ngModelChange)="onBackendChange($event)"
        name="backend"
      >
        <option value="auto">Auto</option>
        @for (b of availableBackends(); track b) {
          <option [value]="b">{{ b | uppercase }}</option>
        }
      </select>
      <span class="badge" [class.active]="activeBackend() !== 'memory'">
        Active: {{ activeBackend() | uppercase }}
      </span>
      @if (storageEstimate(); as est) {
        <span class="badge">
          {{ est.usage }} / {{ est.quota }}
        </span>
      }
      <span
        class="badge"
        [class.active]="persistenceGranted() === true"
        [class.warn]="persistenceGranted() === false"
      >
        Eviction protection: {{ persistenceGranted() === null ? '...' : persistenceGranted() ? 'ON' : 'OFF' }}
      </span>
    </div>
  </header>

  @if (dbError()) {
    <div class="error">{{ dbError() }}</div>
  }

  @if (persistenceGranted() === false) {
    <div class="permission-prompt">
      <p>
        Your data is saved via <strong>{{ activeBackend() | uppercase }}</strong> and will persist across refreshes.
        However, the browser may evict it under storage pressure.
        Request eviction protection to prevent that.
      </p>
      <p class="hint">
        Note: On localhost, browsers often deny this automatically.
        Deploy to HTTPS or install as a PWA for full support.
      </p>
      <button (click)="requestPersistence()">Request Eviction Protection</button>
    </div>
  }

  @if (dbReady()) {
    <section class="todo-section">
      <form (ngSubmit)="addTodo()" class="todo-form">
        <input
          type="text"
          placeholder="Add a new todo..."
          [ngModel]="newTodoTitle()"
          (ngModelChange)="newTodoTitle.set($event)"
          name="title"
        />
        <select
          [ngModel]="newTodoPriority()"
          (ngModelChange)="newTodoPriority.set(+$event)"
          name="priority"
        >
          @for (label of priorityLabels; track $index) {
            <option [value]="$index">{{ label }}</option>
          }
        </select>
        <button type="submit">Add</button>
      </form>

      <ul class="todo-list">
        @for (todo of todos(); track todo.id) {
          <li [class.done]="todo.done">
            <label>
              <input
                type="checkbox"
                [checked]="todo.done"
                (change)="toggleTodo(todo.id)"
              />
              <span class="todo-title">{{ todo.title }}</span>
            </label>
            <span class="priority-badge" [attr.data-priority]="todo.priority">
              {{ priorityLabels[todo.priority] }}
            </span>
            <span class="todo-date">{{ todo.created_at }}</span>
            <button class="delete-btn" (click)="deleteTodo(todo.id)">Delete</button>
          </li>
        } @empty {
          <li class="empty">No todos yet. Add one above!</li>
        }
      </ul>

      <footer class="todo-footer">
        <span>{{ todos().length }} item(s) total</span>
      </footer>
    </section>
  }
</div>
