<mat-toolbar color="primary" class="gap-2">
  <mat-icon>storage</mat-icon>
  <span class="font-medium">PWA SQLite</span>
  <span class="flex-1"></span>
  <span class="text-xs px-2 py-0.5 rounded-full bg-white/10">v{{ dbVersion() }}</span>
  <span
    class="text-xs px-2 py-0.5 rounded-full"
    [class]="activeBackend() !== 'memory' ? 'bg-sky-500/20 text-sky-300' : 'bg-white/10'"
  >
    {{ activeBackend() | uppercase }}
  </span>
</mat-toolbar>

<div class="max-w-2xl mx-auto p-4 flex flex-col gap-4">

  <!-- Status -->
  <mat-card appearance="outlined" class="!p-4">
    <div class="flex items-center gap-4 flex-wrap">
      <mat-form-field appearance="outline" class="!w-40" subscriptSizing="dynamic">
        <mat-label>Backend</mat-label>
        <mat-select
          [ngModel]="preferredBackend()"
          (ngModelChange)="onBackendChange($event)"
        >
          <mat-option value="auto">Auto</mat-option>
          @for (b of availableBackends(); track b) {
            <mat-option [value]="b">{{ b | uppercase }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      @if (storageEstimate(); as est) {
        <span class="text-xs text-[var(--mat-sys-on-surface-variant)]">
          {{ est.usage }} / {{ est.quota }}
        </span>
      }

      @if (persistenceGranted() === false) {
        <button mat-stroked-button (click)="requestPersistence()" class="!text-xs">
          <mat-icon class="!text-base !w-4 !h-4 mr-1">lock</mat-icon>
          Protect from eviction
        </button>
      }
      @if (persistenceGranted() === true) {
        <span class="text-xs text-[var(--mat-sys-primary)] flex items-center gap-1">
          <mat-icon class="!text-base !w-4 !h-4">verified</mat-icon>
          Protected
        </span>
      }
    </div>
  </mat-card>

  @if (dbError()) {
    <mat-card appearance="outlined" class="!bg-[var(--mat-sys-error-container)] !text-[var(--mat-sys-on-error-container)] !p-4">
      <div class="flex items-center gap-2">
        <mat-icon>error</mat-icon>
        {{ dbError() }}
      </div>
    </mat-card>
  }

  @if (dbReady()) {
    <!-- Add Todo -->
    <mat-card appearance="outlined" class="!p-4">
      <form (ngSubmit)="addTodo()" class="flex items-start gap-3">
        <mat-form-field appearance="outline" class="flex-1" subscriptSizing="dynamic">
          <mat-label>New todo</mat-label>
          <input
            matInput
            [ngModel]="newTodoTitle()"
            (ngModelChange)="newTodoTitle.set($event)"
            name="title"
            placeholder="What needs to be done?"
          />
        </mat-form-field>

        <mat-form-field appearance="outline" class="!w-28" subscriptSizing="dynamic">
          <mat-label>Priority</mat-label>
          <mat-select
            [ngModel]="newTodoPriority()"
            (ngModelChange)="newTodoPriority.set(+$event)"
            name="priority"
          >
            @for (label of priorityLabels; track $index) {
              <mat-option [value]="$index">{{ label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <button mat-fab type="submit" color="primary" class="shrink-0">
          <mat-icon>add</mat-icon>
        </button>
      </form>
    </mat-card>

    <!-- Todo List -->
    <mat-card appearance="outlined" class="!p-0 overflow-hidden">
      @for (todo of todos(); track todo.id; let last = $last) {
        <div class="flex items-center gap-3 px-4 py-3 transition-colors hover:bg-white/[0.03]">
          <mat-checkbox
            [checked]="!!todo.done"
            (change)="toggleTodo(todo.id)"
          />
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 flex-wrap">
              <span
                class="text-sm"
                [class]="todo.done ? 'line-through text-[var(--mat-sys-on-surface-variant)]' : ''"
              >
                {{ todo.title }}
              </span>
              <span
                class="text-[0.65rem] font-medium px-2 py-0.5 rounded-full"
                [class]="todo.priority === 2
                  ? 'bg-[var(--mat-sys-error-container)] text-[var(--mat-sys-on-error-container)]'
                  : todo.priority === 1
                    ? 'bg-[var(--mat-sys-tertiary-container)] text-[var(--mat-sys-on-tertiary-container)]'
                    : 'bg-white/[0.06] text-[var(--mat-sys-on-surface-variant)]'"
              >
                {{ priorityLabels[todo.priority] }}
              </span>
            </div>
            <span class="text-[0.7rem] text-[var(--mat-sys-on-surface-variant)] mt-0.5 block">
              {{ todo.created_at }}
            </span>
          </div>
          <button mat-icon-button (click)="deleteTodo(todo.id)" class="shrink-0 !text-[var(--mat-sys-error)] opacity-50 hover:opacity-100">
            <mat-icon>delete_outline</mat-icon>
          </button>
        </div>
        @if (!last) {
          <mat-divider />
        }
      } @empty {
        <div class="flex flex-col items-center gap-3 py-16 text-[var(--mat-sys-on-surface-variant)]">
          <mat-icon class="!text-5xl !w-12 !h-12 opacity-30">checklist</mat-icon>
          <span class="text-sm opacity-60">No todos yet. Add one above!</span>
        </div>
      }
      <div class="px-4 py-2.5 text-center text-xs text-[var(--mat-sys-on-surface-variant)] border-t border-[var(--mat-sys-outline-variant)]">
        {{ todos().length }} item(s)
      </div>
    </mat-card>
  }
</div>
